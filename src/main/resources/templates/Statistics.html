<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inkwell - Statistics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'accent-blue': '#0ea5e9',
                        'accent-cyan': '#06b6d4',
                        'bg-dark': '#030712',
                        'bg-card': '#111827',
                        'bg-card-hover': '#1f2937'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Core Styles */
        body {
            background-color: #030712;
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #111827;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #0ea5e9;
        }

        /* Stats card with hover effects */
        .stats-card {
            display: flex;
            flex-direction: column;
            background: linear-gradient(145deg, #151e30, #0f1625);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            transition: all 0.5s cubic-bezier(0.33, 1, 0.68, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transform: perspective(1000px) translateZ(0);
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }
        
        /* Glow effect */
        .stats-card::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.1), transparent);
            z-index: -1;
            opacity: 0;
            border-radius: 14px;
            transition: opacity 0.5s ease-in-out;
            filter: blur(8px);
        }
        
        /* Top border accent */
        .stats-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.3), transparent);
            transform: scaleX(0);
            transition: transform 0.6s cubic-bezier(0.33, 1, 0.68, 1);
        }
        
        /* Card hover effect */
        .stats-card:hover {
            transform: perspective(1000px) translateY(-8px) rotateX(2deg) translateZ(10px);
            border-color: rgba(14, 165, 233, 0.15);
            box-shadow: 
                0 15px 30px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(14, 165, 233, 0.1);
            filter: brightness(1.05);
        }
        
        /* Activate glow and border accent */
        .stats-card:hover::before {
            opacity: 1;
        }
        
        .stats-card:hover::after {
            transform: scaleX(1);
        }
        
        .chart-container {
            position: relative;
            transition: all 0.5s cubic-bezier(0.33, 1, 0.68, 1);
        }
        
        .stats-card:hover .chart-container {
            transform: translateZ(5px);
        }
        
        /* Icon animation */
        .stats-icon-container {
            transition: all 0.5s cubic-bezier(0.33, 1, 0.68, 1);
        }
        
        .stats-card:hover .stats-icon-container {
            transform: scale(1.1) translateZ(10px);
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(90deg, #0ea5e9, #06b6d4);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Fancy buttons */
        .btn-primary {
            background: linear-gradient(90deg, #0ea5e9, #06b6d4);
            color: white;
            border-radius: 8px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transition: width 0.3s ease;
            z-index: -1;
        }
        
        .btn-primary:hover::before {
            width: 100%;
        }
        
        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(14, 165, 233, 0.1);
            color: #0ea5e9;
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 8px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: rgba(14, 165, 233, 0.2);
            border-color: #0ea5e9;
        }
        
        /* Select control */
        .filter-control {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: white;
            transition: all 0.3s;
        }
        
        .filter-control:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3);
            outline: none;
        }
        
        /* Comment card animation */
        .comment-card {
            transition: all 0.3s ease;
        }
        
        .comment-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border-color: rgba(14, 165, 233, 0.3);
        }
    </style>
    <style th:replace="fragments/sidebar :: sidebar-style"></style>
    <style th:replace="fragments/FantasyBackground :: fantasy-style"></style>
</head>
<body class="bg-bg-dark text-gray-100 font-sans min-h-screen">
    <div class="flex min-h-screen">
        <!-- Fantasy Background -->
        <div th:replace="fragments/FantasyBackground :: fantasy-elements"></div>
        
        <!-- Sidebar trigger -->
        <div th:replace="fragments/sidebar :: sidebar-trigger"></div>
        
        <!-- Sidebar -->
        <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col relative">
            <!-- Main Content Area -->
            <main class="flex-1 py-8 md:py-12 px-4">
                <div class="max-w-7xl mx-auto">
                    <!-- Header Section -->
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold mb-2">Your <span class="gradient-text">Statistics</span></h1>
                        <p class="text-gray-400">Track your writing progress and reader engagement</p>
                    </div>
                    
                    <!-- Overall Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stats-card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-accent-blue bg-opacity-10 text-accent-blue mr-4 stats-icon-container">
                                    <i class="fas fa-book text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Total Stories</p>
                                    <h3 class="text-2xl font-bold" th:text="${userStats.get('totalStories') != null ? userStats.get('totalStories') : '0'}">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="stats-card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-accent-cyan bg-opacity-10 text-accent-cyan mr-4 stats-icon-container">
                                    <i class="fas fa-eye text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Total Reads</p>
                                    <h3 class="text-2xl font-bold" th:text="${userStats.get('totalReads') != null ? userStats.get('totalReads') : '0'}">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="stats-card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-500 bg-opacity-10 text-green-500 mr-4 stats-icon-container">
                                    <i class="fas fa-thumbs-up text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Total Likes</p>
                                    <h3 class="text-2xl font-bold" th:text="${userStats.get('totalLikes') != null ? userStats.get('totalLikes') : '0'}">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="stats-card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-yellow-500 bg-opacity-10 text-yellow-500 mr-4 stats-icon-container">
                                    <i class="fas fa-comment text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Total Comments</p>
                                    <h3 class="text-2xl font-bold" th:text="${userStats.get('totalComments') != null ? userStats.get('totalComments') : '0'}">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Reads Over Time Chart -->
                        <div class="stats-card p-6">
                            <h3 class="text-xl font-bold mb-4">Reads Over Time</h3>
                            <div class="h-64 chart-container">
                                <canvas id="readsChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Engagement Chart -->
                        <div class="stats-card p-6">
                            <h3 class="text-xl font-bold mb-4">Engagement Metrics</h3>
                            <div class="h-64 chart-container">
                                <canvas id="engagementChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Story Selection -->
                    <div class="stats-card p-6 mb-8">
                        <h3 class="text-xl font-bold mb-4">Story Statistics</h3>
                        
                        <div th:if="${userStories.isEmpty()}" class="text-center py-8">
                            <div class="text-5xl text-gray-600 mb-4">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-2">No stories to analyze</h3>
                            <p class="text-gray-400 mb-4">Create stories to see detailed statistics</p>
                            <a href="/Writing" class="btn-primary inline-flex items-center gap-2">
                                <i class="fas fa-pen-nib"></i>
                                Create a Story
                            </a>
                        </div>
                        
                        <div th:if="${!userStories.isEmpty()}" class="space-y-6">
                            <div class="mb-4">
                                <label for="storySelect" class="block text-gray-300 mb-2">Select a story:</label>
                                <select id="storySelect" class="w-full filter-control">
                                    <option th:each="story : ${userStories}" th:value="${story.id}" th:text="${story.title}" th:selected="${selectedStory != null && selectedStory.id == story.id}">Story Title</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="bg-bg-card p-4 rounded-lg border border-gray-800 hover:border-accent-blue transition-colors">
                                    <p class="text-sm text-gray-400">Reads</p>
                                    <h4 class="text-xl font-bold" id="story-reads" th:text="${storyStats != null ? storyStats.get('reads') : '0'}">0</h4>
                                </div>
                                <div class="bg-bg-card p-4 rounded-lg border border-gray-800 hover:border-accent-blue transition-colors">
                                    <p class="text-sm text-gray-400">Story Likes</p>
                                    <h4 class="text-xl font-bold" id="story-likes" th:text="${storyStats != null && storyStats.get('storyLikes') != null ? storyStats.get('storyLikes') : '0'}">0</h4>
                                </div>
                                <div class="bg-bg-card p-4 rounded-lg border border-gray-800 hover:border-accent-blue transition-colors">
                                    <p class="text-sm text-gray-400">Chapter Likes</p>
                                    <h4 class="text-xl font-bold" id="chapter-likes" th:text="${storyStats != null && storyStats.get('chapterLikes') != null ? storyStats.get('chapterLikes') : '0'}">0</h4>
                                </div>
                                <div class="bg-bg-card p-4 rounded-lg border border-gray-800 hover:border-accent-blue transition-colors">
                                    <p class="text-sm text-gray-400">Comments</p>
                                    <h4 class="text-xl font-bold" id="story-comments" th:text="${storyStats != null && storyStats.get('comments') != null ? storyStats.get('comments') : '0'}">0</h4>
                                </div>
                            </div>
                            
                            <div class="bg-bg-card p-4 rounded-lg border border-gray-800">
                                <h4 class="font-bold mb-2">Chapter Performance</h4>
                                <div id="chapter-chart-container" class="h-64">
                                    <canvas id="chapterPerformanceChart"></canvas>
                                </div>
                                <div id="no-chapters-message" class="hidden text-center py-8">
                                    <div class="text-4xl text-gray-600 mb-4">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <h3 class="text-lg font-bold mb-2">No chapter data available</h3>
                                    <p class="text-gray-400">Add chapters to see performance statistics</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comment Analysis Section -->
                    <div class="stats-card p-6 mb-8" id="comment-analysis-section">
                        <h3 class="text-xl font-bold mb-4">Comment Analysis</h3>
                        
                        <div id="no-comments-message" class="hidden text-center py-8">
                            <div class="text-5xl text-gray-600 mb-4">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-2">No comments yet</h3>
                            <p class="text-gray-400 mb-4">Your story hasn't received any comments</p>
                        </div>
                        
                        <div id="comments-content" class="space-y-6">
                            <!-- Comment Distribution -->
                            <div class="bg-bg-card p-4 rounded-lg border border-gray-800">
                                <h4 class="font-bold mb-2">Comment Distribution</h4>
                                <div id="comment-distribution-chart-container" class="h-64">
                                    <canvas id="commentDistributionChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Recent Comments -->
                            <div class="bg-bg-card p-4 rounded-lg border border-gray-800">
                                <h4 class="font-bold mb-2">Recent Comments</h4>
                                <div id="recent-comments-container" class="space-y-4">
                                    <div id="loading-comments" class="text-center py-4">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-blue mx-auto"></div>
                                        <p class="mt-2 text-gray-400">Loading comments...</p>
                                    </div>
                                    <div id="no-recent-comments" class="hidden text-center py-4">
                                        <p class="text-gray-400">No recent comments to display</p>
                                    </div>
                                    <div id="recent-comments-list" class="hidden space-y-4">
                                        <!-- Comments will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Writing Habits -->
                    <div class="stats-card p-6">
                        <h3 class="text-xl font-bold mb-4">Writing Habits</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-bg-card p-4 rounded-lg border border-gray-800">
                                <h4 class="font-bold mb-2">Writing Activity</h4>
                                <div class="h-64 chart-container">
                                    <canvas id="writingActivityChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-bg-card p-4 rounded-lg border border-gray-800">
                                <h4 class="font-bold mb-2">Word Count Progress</h4>
                                <div class="h-64 chart-container">
                                    <canvas id="wordCountChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Footer -->
            <footer class="bg-bg-card py-10 mt-auto border-t border-gray-800">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="grid md:grid-cols-4 gap-8">
                        <div class="md:col-span-2">
                            <a href="/Home" class="text-2xl font-bold gradient-text inline-block mb-3">Inkwell</a>
                            <p class="text-gray-400 max-w-md">
                                A platform for writers and readers to connect through the power of storytelling. 
                                Create, share, and discover stories that captivate and inspire.
                            </p>
                            <div class="flex mt-6 space-x-4">
                                <a href="#" class="text-gray-400 hover:text-accent-blue transition-colors">
                                    <i class="fab fa-twitter text-xl"></i>
                                </a>
                                <a href="#" class="text-gray-400 hover:text-accent-blue transition-colors">
                                    <i class="fab fa-facebook text-xl"></i>
                                </a>
                                <a href="#" class="text-gray-400 hover:text-accent-blue transition-colors">
                                    <i class="fab fa-instagram text-xl"></i>
                                </a>
                                <a href="#" class="text-gray-400 hover:text-accent-blue transition-colors">
                                    <i class="fab fa-github text-xl"></i>
                                </a>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-4 text-white">Navigation</h3>
                            <ul class="space-y-2">
                                <li>
                                    <a href="/Home" class="text-gray-400 hover:text-accent-blue transition-colors">Home</a>
                                </li>
                                <li>
                                    <a href="/Library" class="text-gray-400 hover:text-accent-blue transition-colors">Library</a>
                                </li>
                                <li>
                                    <a href="/Dashboard" class="text-gray-400 hover:text-accent-blue transition-colors">Dashboard</a>
                                </li>
                                <li>
                                    <a href="/Writing" class="text-gray-400 hover:text-accent-blue transition-colors">Write</a>
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-4 text-white">Legal</h3>
                            <ul class="space-y-2">
                                <li>
                                    <a href="#" class="text-gray-400 hover:text-accent-blue transition-colors">Terms of Service</a>
                                </li>
                                <li>
                                    <a href="#" class="text-gray-400 hover:text-accent-blue transition-colors">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="#" class="text-gray-400 hover:text-accent-blue transition-colors">Copyright</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-8 pt-8 border-t border-gray-800 flex flex-col md:flex-row justify-between items-center">
                        <p class="text-gray-400 text-sm">
                            &copy; 2023-2025 Inkwell. All rights reserved.
                        </p>
                        <div class="mt-4 md:mt-0">
                            <a href="#" class="text-sm text-accent-blue hover:underline">Back to top</a>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script th:replace="~{fragments/sidebar :: sidebar-script}"></script>
    <script th:replace="fragments/FantasyBackground :: fantasy-script"></script>
    <script>
        // Initialize chart objects
        let readsChart, engagementChart, chapterChart, activityChart, wordCountChart;
        
        // Get the months for the last 3 months
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const currentMonth = new Date().getMonth();
        const last3Months = [
            months[(currentMonth + 10) % 12],
            months[(currentMonth + 11) % 12],
            months[currentMonth]
        ];
        
        // Days of the week
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        
        // Chart configuration
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(17, 24, 39, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#d1d5db',
                    borderColor: 'rgba(14, 165, 233, 0.3)',
                    borderWidth: 1,
                    padding: 10,
                    boxPadding: 5,
                    usePointStyle: true,
                    callbacks: {
                        labelPointStyle: function(context) {
                            return {
                                pointStyle: 'rectRounded',
                                rotation: 0
                            };
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            }
        };
        
        // Initialize empty charts
        function initializeCharts() {
            // Reads Chart
            const readsCtx = document.getElementById('readsChart').getContext('2d');
            readsChart = new Chart(readsCtx, {
                type: 'line',
                data: {
                    labels: last3Months,
                    datasets: [{
                        label: 'Reads',
                        data: [0, 0, 0],
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: chartConfig
            });
            
            // Engagement Chart
            const engagementCtx = document.getElementById('engagementChart').getContext('2d');
            engagementChart = new Chart(engagementCtx, {
                type: 'bar',
                data: {
                    labels: ['Story Likes', 'Chapter Likes', 'Comments', 'Shares', 'Bookmarks'],
                    datasets: [{
                        label: 'Engagement',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(14, 165, 233, 0.7)',
                            'rgba(6, 182, 212, 0.7)',
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(139, 92, 246, 0.7)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: chartConfig
            });
            
            // Writing Activity Chart
            const activityCtx = document.getElementById('writingActivityChart').getContext('2d');
            activityChart = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Hours',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: chartConfig
            });
            
            // Word Count Chart
            const wordCountCtx = document.getElementById('wordCountChart').getContext('2d');
            wordCountChart = new Chart(wordCountCtx, {
                type: 'line',
                data: {
                    labels: last3Months,
                    datasets: [{
                        label: 'Words',
                        data: [0, 0, 0],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: chartConfig
            });
        }
        
        // Initialize chapter performance chart
        function initializeChapterChart(labels, readsData, likesData) {
            const chapterCtx = document.getElementById('chapterPerformanceChart').getContext('2d');
            
            // If chart already exists, destroy it
            if (chapterChart) {
                chapterChart.destroy();
            }
            
            chapterChart = new Chart(chapterCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Reads',
                        data: readsData,
                        backgroundColor: 'rgba(14, 165, 233, 0.7)',
                        borderWidth: 0
                    },
                    {
                        label: 'Likes',
                        data: likesData,
                        backgroundColor: 'rgba(6, 182, 212, 0.7)',
                        borderWidth: 0
                    }] 
                },
                options: {
                    ...chartConfig,
                    plugins: {
                        ...chartConfig.plugins,
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        }
        
        // Story selection change handler
        const storySelect = document.getElementById('storySelect');
        if (storySelect) {
            storySelect.addEventListener('change', function() {
                const storyId = this.value;
                if (storyId) {
                    fetchStoryStatistics(storyId);
                }
            });
        }

        // Function to fetch story statistics from the server
        function fetchStoryStatistics(storyId) {
            fetch(`/api/statistics/story/${storyId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    try {
                        // Update story stats cards with defensive checks
                        document.getElementById('story-reads').textContent = data?.reads || 0;
                        document.getElementById('story-likes').textContent = data?.storyLikes || 0;
                        document.getElementById('chapter-likes').textContent = data?.chapterLikes || 0;
                        document.getElementById('story-comments').textContent = data?.comments || 0;
                        
                        // Update chapter performance chart with null check
                        if (data && data.chapterStats && data.chapterStats.length > 0) {
                            updateChapterPerformanceChart(data.chapterStats);
                        } else {
                            // Show no chapters message if no data
                            document.getElementById('chapter-chart-container').classList.add('hidden');
                            document.getElementById('no-chapters-message').classList.remove('hidden');
                        }
                        
                        // Update other charts with real data and null checks
                        if (data) {
                            if (data.readsByMonth) updateReadsChart(data.readsByMonth);
                            if (data.engagement) updateEngagementChart(data.engagement);
                            if (data.writingActivity) updateWritingActivityChart(data.writingActivity);
                            if (data.wordCountByMonth) updateWordCountChart(data.wordCountByMonth);
                            
                            // Update comment section
                            updateCommentSection(storyId);
                        }
                    } catch (err) {
                        console.error('Error processing statistics data:', err);
                        // Show error message but continue showing UI
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'bg-red-500 bg-opacity-50 text-white p-2 rounded-lg mb-2 text-sm';
                        errorMsg.textContent = 'There was an error processing some statistics data.';
                        
                        const statsCard = document.querySelector('.stats-card');
                        if (statsCard && !document.querySelector('.stats-error-message')) {
                            errorMsg.classList.add('stats-error-message');
                            statsCard.prepend(errorMsg);
                            // Auto-remove after 5 seconds
                            setTimeout(() => errorMsg.remove(), 5000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching story statistics:', error);
                    // Show error message to user but don't use alert (less disruptive)
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'bg-red-500 text-white p-4 rounded-lg mb-4';
                    errorMsg.textContent = 'Failed to load statistics. Please try again later.';
                    document.querySelector('.max-w-7xl').prepend(errorMsg);
                });
        }

        // Function to update chapter performance chart
        function updateChapterPerformanceChart(chapterStats) {
            const chartContainer = document.getElementById('chapter-chart-container');
            const noChaptersMessage = document.getElementById('no-chapters-message');
            
            if (!chapterStats || !Array.isArray(chapterStats) || chapterStats.length === 0) {
                // No chapters available, show message
                chartContainer.classList.add('hidden');
                noChaptersMessage.classList.remove('hidden');
                return;
            }
            
            // Chapters available, show chart
            chartContainer.classList.remove('hidden');
            noChaptersMessage.classList.add('hidden');

            try {
                const labels = chapterStats.map(chapter => 
                    `Chapter ${chapter.chapterNumber || '?'}${chapter.title ? ': ' + chapter.title : ''}`
                );
                const readsData = chapterStats.map(chapter => chapter.readCount || 0);
                const likesData = chapterStats.map(chapter => chapter.likeCount || 0);
                
                initializeChapterChart(labels, readsData, likesData);
            } catch (err) {
                console.error('Error rendering chapter chart:', err);
                chartContainer.classList.add('hidden');
                noChaptersMessage.classList.remove('hidden');
            }  
        }

        // Function to update reads chart
        function updateReadsChart(readsByMonth) {
            if (!readsByMonth) return;
            
            // Get data for the last 3 months
            const currentMonth = new Date().getMonth();
            const data = [
                readsByMonth[(currentMonth + 10) % 12] || 0,
                readsByMonth[(currentMonth + 11) % 12] || 0,
                readsByMonth[currentMonth] || 0
            ];
            
            readsChart.data.datasets[0].data = data;
            readsChart.update();
        }

        // Function to update engagement chart
        function updateEngagementChart(engagement) {
            if (!engagement) return;
            
            const data = [
                engagement.storyLikes || 0,
                engagement.chapterLikes || 0,
                engagement.comments || 0,
                engagement.shares || 0,
                engagement.bookmarks || 0
            ];
            
            engagementChart.data.datasets[0].data = data;
            engagementChart.update();
        }

        // Function to update writing activity chart
        function updateWritingActivityChart(writingActivity) {
            if (!writingActivity) return;
            
            activityChart.data.datasets[0].data = writingActivity;
            activityChart.update();
        }

        // Function to update word count chart
        function updateWordCountChart(wordCountByMonth) {
            if (!wordCountByMonth) return;
            
            // Get data for the last 3 months
            const currentMonth = new Date().getMonth();
            const data = [
                wordCountByMonth[(currentMonth + 10) % 12] || 0,
                wordCountByMonth[(currentMonth + 11) % 12] || 0,
                wordCountByMonth[currentMonth] || 0
            ];
            
            wordCountChart.data.datasets[0].data = data;
            wordCountChart.update();
        }

        // Initialize comment distribution chart
        function initializeCommentDistributionChart(labels, data) {
            const ctx = document.getElementById('commentDistributionChart').getContext('2d');
            
            // If chart already exists, destroy it
            if (window.commentDistributionChart instanceof Chart) {
                window.commentDistributionChart.destroy();
            }
            
            window.commentDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Comments',
                        data: data,
                        backgroundColor: 'rgba(6, 182, 212, 0.7)',
                        borderWidth: 0
                    }]
                },
                options: chartConfig
            });
        }

        // Function to update comment section
        function updateCommentSection(storyId) {
            const commentAnalysisSection = document.getElementById('comment-analysis-section');
            const noCommentsMessage = document.getElementById('no-comments-message');
            const commentsContent = document.getElementById('comments-content');
            const loadingComments = document.getElementById('loading-comments');
            const noRecentComments = document.getElementById('no-recent-comments');
            const recentCommentsList = document.getElementById('recent-comments-list');
            
            // Show loading state
            loadingComments.classList.remove('hidden');
            noRecentComments.classList.add('hidden');
            recentCommentsList.classList.add('hidden');
            recentCommentsList.innerHTML = '';
            
            // Fetch comment data
            fetch(`/api/statistics/story/${storyId}/comments`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading state
                    loadingComments.classList.add('hidden');
                    
                    // Check if there are any comments
                    const totalComments = data.totalStoryComments || 0;
                    
                    if (totalComments === 0) {
                        noCommentsMessage.classList.remove('hidden');
                        commentsContent.classList.add('hidden');
                        return;
                    }
                    
                    // Show comments content
                    noCommentsMessage.classList.add('hidden');
                    commentsContent.classList.remove('hidden');
                    
                    // Display recent comments
                    const recentComments = data.storyComments || [];
                    
                    if (recentComments.length === 0) {
                        noRecentComments.classList.remove('hidden');
                        recentCommentsList.classList.add('hidden');
                    } else {
                        noRecentComments.classList.add('hidden');
                        recentCommentsList.classList.remove('hidden');
                        
                        // Create comment elements
                        recentComments.forEach(comment => {
                            const commentElement = document.createElement('div');
                            commentElement.className = 'bg-bg-card p-4 rounded-lg border border-gray-800 comment-card';
                            
                            const createdDate = new Date(comment.createdAt);
                            const formattedDate = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString();
                            
                            commentElement.innerHTML = `
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-medium text-accent-blue">${comment.username}</div>
                                    <div class="text-xs text-gray-400">${formattedDate}</div>
                                </div>
                                <p class="text-gray-300">${comment.content}</p>
                            `;
                            
                            recentCommentsList.appendChild(commentElement);
                        });
                    }
                    
                    // Update comment distribution chart
                    const chapterComments = data.chapterComments || {};
                    const labels = Object.keys(chapterComments).map(chapterId => `Chapter ${chapterId}`);
                    const commentCounts = Object.values(chapterComments).map(comments => comments.length);
                    
                    initializeCommentDistributionChart(labels, commentCounts);
                })
                .catch(error => {
                    console.error('Error fetching comment data:', error);
                    loadingComments.classList.add('hidden');
                    noRecentComments.classList.remove('hidden');
                });
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize empty charts
            initializeCharts();
            
            // If a story is already selected, fetch its statistics
            const storySelect = document.getElementById('storySelect');
            if (storySelect && storySelect.value) {
                fetchStoryStatistics(storySelect.value);
            }
            
            // Add card hover effects
            const statsCards = document.querySelectorAll('.stats-card');
            statsCards.forEach(card => {
                card.addEventListener('mousemove', handleCardTilt);
                card.addEventListener('mouseleave', resetCardTilt);
            });
            
            // Theme setup
            const savedTheme = localStorage.getItem('interfaceTheme') || 'none';
            if (window.setTheme) {
                window.setTheme(savedTheme);
            }
            
            // Initialize staggered entry animations
            initializeCardAnimations();
        });
        
        // 3D tilt effect function
        function handleCardTilt(e) {
            const card = this;
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const rotateY = ((x - centerX) / centerX) * 3;
            const rotateX = -((y - centerY) / centerY) * 3;
            
            card.style.transform = `perspective(1000px) translateY(-4px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateZ(10px)`;
        }
        
        function resetCardTilt(e) {
            this.style.transform = 'perspective(1000px) translateZ(0)';
        }
        
        // Staggered entry animations
        function initializeCardAnimations() {
            const cards = document.querySelectorAll('.stats-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.8s cubic-bezier(0.33, 1, 0.68, 1)';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100 + index * 120);
            });
        }
    </script>
</body>
</html>